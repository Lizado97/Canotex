<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canotex - Sistema de Presupuestos</title>
   
    <!-- Librer√≠as para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
   
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
            min-height: 100vh;
            color: #e2e8f0;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            position: relative;
            z-index: 1;
        }

        @media (min-width: 768px) {
            .container {
                padding: 2rem;
            }
        }

        .header {
            position: relative;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.5);
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .header {
                padding: 2rem 2rem 2rem 5rem;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
            }
        }

        .header h1 {
            color: #e2e8f0;
            font-size: 1.5rem;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        @media (min-width: 768px) {
            .header h1 {
                font-size: 2rem;
                text-align: left;
            }
        }

        .btn {
            padding: 0.625rem 1rem;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
            box-shadow: 0 4px 15px 0 rgba(0, 0, 0, 0.3);
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .btn {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
            }
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(99, 102, 241, 0.6);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(16, 185, 129, 0.5);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: 1.25rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.4);
            margin-bottom: 1.5rem;
            overflow: visible !important;
        }

        @media (min-width: 768px) {
            .card {
                padding: 2rem;
                margin-bottom: 2rem;
            }
        }

        .card h2 {
            color: #e2e8f0;
            margin-bottom: 1.25rem;
            font-size: 1.25rem;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @media (min-width: 768px) {
            .card h2 {
                margin-bottom: 1.5rem;
                font-size: 1.5rem;
            }
        }

        .form-group {
            margin-bottom: 1.25rem;
            position: relative;
            z-index: inherit;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #cbd5e1;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            font-size: 0.95rem;
            background: rgba(255, 255, 255, 0.07);
            color: #e2e8f0;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #6366f1;
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .form-group input::placeholder {
            color: #64748b;
        }

        .grid {
            display: grid;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .grid {
                gap: 1.5rem;
            }
        }

        .grid-2 {
            grid-template-columns: 1fr;
        }

        @media (min-width: 768px) {
            .grid-2 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .item-list {
            margin-top: 1rem;
        }

        .item {
            background: rgba(255, 255, 255, 0.04);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s;
        }

        @media (min-width: 768px) {
            .item {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }
        }

        .item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(99, 102, 241, 0.4);
            transform: translateX(3px);
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-info h4 {
            color: #e2e8f0;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            word-wrap: break-word;
        }

        @media (min-width: 768px) {
            .item-info h4 {
                font-size: 1.05rem;
            }
        }

        .item-info p {
            color: #94a3b8;
            font-size: 0.8rem;
            line-height: 1.5;
        }

        @media (min-width: 768px) {
            .item-info p {
                font-size: 0.875rem;
            }
        }

        .item-price {
            font-size: 1.25rem;
            font-weight: bold;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-right: 0;
            text-align: right;
        }

        @media (min-width: 768px) {
            .item-price {
                font-size: 1.4rem;
                margin-right: 1rem;
            }
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .resumen {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.25) 0%, rgba(139, 92, 246, 0.25) 100%);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(167, 139, 250, 0.4);
            color: white;
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px 0 rgba(99, 102, 241, 0.4);
            margin-bottom: 1.5rem;
        }

        @media (min-width: 1024px) {
            .resumen {
                padding: 2rem;
                position: sticky;
                top: 2rem;
                margin-bottom: 0;
            }
        }

        .resumen h3 {
            margin-bottom: 1.25rem;
            font-size: 1.25rem;
        }

        @media (min-width: 768px) {
            .resumen h3 {
                margin-bottom: 1.5rem;
                font-size: 1.5rem;
            }
        }

        .resumen-linea {
            display: flex;
            justify-content: space-between;
            padding: 0.875rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.15);
            font-size: 0.95rem;
        }

        @media (min-width: 768px) {
            .resumen-linea {
                padding: 1rem 0;
                font-size: 1rem;
            }
        }

        .resumen-total {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 2px solid rgba(255,255,255,0.3);
        }

        @media (min-width: 768px) {
            .resumen-total {
                font-size: 1.75rem;
                margin-top: 1rem;
                padding-top: 1rem;
            }
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .tabla {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.8rem;
        }

        @media (min-width: 768px) {
            .tabla {
                font-size: 0.95rem;
            }
        }

        .tabla thead {
            background: rgba(255, 255, 255, 0.05);
        }

        .tabla th {
            padding: 0.75rem 0.5rem;
            text-align: left;
            color: #cbd5e1;
            font-weight: 600;
            border-bottom: 2px solid rgba(255, 255, 255, 0.15);
        }

        @media (min-width: 768px) {
            .tabla th {
                padding: 1rem;
            }
        }

        .tabla td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            color: #e2e8f0;
        }

        @media (min-width: 768px) {
            .tabla td {
                padding: 1rem;
            }
        }

        .tabla tbody tr {
            transition: all 0.3s;
        }

        .tabla tbody tr:hover {
            background: rgba(255, 255, 255, 0.08);
            cursor: pointer;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        @media (min-width: 768px) {
            .badge {
                font-size: 0.75rem;
            }
        }

        .badge-borrador {
            background: rgba(148, 163, 184, 0.2);
            color: #cbd5e1;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (min-width: 640px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 768px) {
            .stats {
                gap: 1.5rem;
                margin-bottom: 2rem;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.25) 0%, rgba(139, 92, 246, 0.25) 100%);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(167, 139, 250, 0.4);
            color: white;
            padding: 1.25rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(99, 102, 241, 0.4);
            transition: all 0.3s;
        }

        @media (min-width: 768px) {
            .stat-card {
                padding: 1.5rem;
                border-radius: 20px;
            }
        }

        .stat-card h3 {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        @media (min-width: 768px) {
            .stat-card h3 {
                font-size: 0.875rem;
            }
        }

        .stat-card .value {
            font-size: 1.75rem;
            font-weight: bold;
        }

        @media (min-width: 768px) {
            .stat-card .value {
                font-size: 2rem;
            }
        }
      
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 999;
            display: none;
            backdrop-filter: blur(3px);
        }

        .menu-overlay.active {
            display: block;
        }

        .menu-lateral {
            position: fixed;
            top: 0;
            left: -100%;
            width: 85%;
            max-width: 350px;
            height: 100%;
            background: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%);
            backdrop-filter: blur(15px);
            border-right: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 4px 0 30px rgba(0, 0, 0, 0.6);
            transition: left 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .menu-lateral.active {
            left: 0;
        }

        .menu-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        @media (min-width: 768px) {
            .menu-header {
                padding: 2rem;
            }
        }

        .menu-header h2 {
            color: #e2e8f0;
            font-size: 1.25rem;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @media (min-width: 768px) {
            .menu-header h2 {
                font-size: 1.5rem;
            }
        }

        .menu-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .menu-content {
                padding: 1.5rem;
            }
        }

        .menu-item {
            padding: 1rem 1.25rem;
            margin-bottom: 0.5rem;
            border-radius: 12px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.95rem;
        }

        .menu-item:hover {
            background: rgba(99, 102, 241, 0.25);
            transform: translateX(5px);
        }

        .menu-footer {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        @media (min-width: 768px) {
            .menu-footer {
                padding: 1.5rem;
            }
        }

        .btn-hamburguesa {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 998;
            background: rgba(99, 102, 241, 0.3);
            border: 1px solid rgba(99, 102, 241, 0.5);
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }

        @media (min-width: 768px) {
            .btn-hamburguesa {
                width: 50px;
                height: 50px;
                top: 2rem;
                left: 2rem;
            }
        }

        .btn-hamburguesa:hover {
            background: rgba(99, 102, 241, 0.5);
            transform: scale(1.05);
        }

        .btn-hamburguesa span {
            display: block;
            width: 22px;
            height: 2px;
            background: white;
            position: relative;
        }

        @media (min-width: 768px) {
            .btn-hamburguesa span {
                width: 25px;
            }
        }

        .btn-hamburguesa span::before,
        .btn-hamburguesa span::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            background: white;
            left: 0;
            transition: all 0.3s;
        }

        .btn-hamburguesa span::before {
            top: -7px;
        }

        .btn-hamburguesa span::after {
            top: 7px;
        }

        .btn-hamburguesa:hover span::before {
            top: -8px;
        }

        .btn-hamburguesa:hover span::after {
            top: 8px;
        }

        .presupuesto-documento {
            background: white;
            color: #1e293b;
            padding: 20px;
            border-radius: 8px;
            max-width: 850px;
            margin: 0 auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        @media (min-width: 768px) {
            .presupuesto-documento {
                padding: 40px;
            }
        }

        .stat-card.clickable {
            cursor: pointer;
            transition: all 0.3s;
        }

        .stat-card.clickable:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px 0 rgba(99, 102, 241, 0.5);
        }

        .stat-card.clickable:active {
            transform: translateY(-2px);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-top: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s;
        }

        .checkbox-container:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
            accent-color: #6366f1;
        }

        .checkbox-container label {
            cursor: pointer;
            margin: 0;
            font-weight: 500;
            color: #cbd5e1;
            font-size: 0.9rem;
        }

        .search-box {
            position: relative;
            z-index: 10000;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 27, 75, 0.98);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 99999;
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.6);
            margin-top: 0.5rem;
        }

        @media (min-width: 768px) {
            .search-results {
                max-height: 300px;
            }
        }

        .search-result-item {
            padding: 0.875rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            transition: all 0.3s;
            font-size: 0.875rem;
        }

        @media (min-width: 768px) {
            .search-result-item {
                padding: 1rem;
                font-size: 0.95rem;
            }
        }

        .search-result-item:hover {
            background: rgba(99, 102, 241, 0.25);
            transform: translateX(5px);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .aviso-orientativo {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.25) 0%, rgba(245, 158, 11, 0.25) 100%);
            border: 2px solid rgba(251, 191, 36, 0.4);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .aviso-orientativo strong {
            color: #fbbf24;
            font-size: 0.95rem;
            display: block;
        }

        @media (min-width: 768px) {
            .aviso-orientativo strong {
                font-size: 1rem;
            }
        }

        .aviso-orientativo p {
            color: #fcd34d;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        @media (min-width: 768px) {
            .aviso-orientativo p {
                font-size: 0.85rem;
            }
        }

        .tabla-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
        }

        .step-box {
            padding: 1.25rem;
            border-radius: 16px;
            border: 2px solid;
            margin-bottom: 1.25rem;
            overflow: visible !important;
            position: relative;
            transition: all 0.3s;
        }

        @media (min-width: 768px) {
            .step-box {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
        }

        .step-box:hover {
            border-width: 2px;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .step-blue {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12) 0%, rgba(99, 102, 241, 0.12) 100%);
            border-color: rgba(99, 102, 241, 0.4);
        }

        .step-purple {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.12) 0%, rgba(167, 139, 250, 0.12) 100%);
            border-color: rgba(167, 139, 250, 0.4);
        }

        .step-amber {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.12) 0%, rgba(245, 158, 11, 0.12) 100%);
            border-color: rgba(251, 191, 36, 0.4);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        @media (min-width: 768px) {
            .step-header {
                gap: 1rem;
                margin-bottom: 1.5rem;
            }
        }

        .step-number {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            flex-shrink: 0;
            box-shadow: 0 4px 15px 0 rgba(0, 0, 0, 0.4);
        }

        @media (min-width: 768px) {
            .step-number {
                width: 40px;
                height: 40px;
                font-size: 1.25rem;
            }
        }

        .step-blue .step-number {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
        }

        .step-purple .step-number {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        }

        .step-amber .step-number {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }

        .step-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #e2e8f0;
        }

        @media (min-width: 768px) {
            .step-title {
                font-size: 1.25rem;
            }
        }

        .color-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border: 2px solid rgba(255, 255, 255, 0.12);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.04);
        }

        .color-option:hover {
            border-color: rgba(99, 102, 241, 0.6);
            background: rgba(99, 102, 241, 0.15);
            transform: translateX(8px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .color-option.selected {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.25);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .color-swatch {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .filtros-gestion {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (min-width: 640px) {
            .filtros-gestion {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .filtros-gestion {
                grid-template-columns: repeat(4, 1fr);
                margin-bottom: 2rem;
            }
        }

        .grafica-container {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 2px solid rgba(99, 102, 241, 0.3);
            box-shadow: 0 15px 50px 0 rgba(99, 102, 241, 0.4);
            padding: 1.5rem;
            border-radius: 20px;
            margin-top: 1.5rem;
        }

        @media (min-width: 768px) {
            .grafica-container {
                padding: 2rem;
                margin-top: 2rem;
            }
        }

        .grafica-barras {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 250px;
            padding: 1.5rem 0.5rem;
            border-bottom: 3px solid rgba(99, 102, 241, 0.4);
            background: linear-gradient(180deg, transparent 0%, rgba(99, 102, 241, 0.08) 100%);
            border-radius: 12px;
        }

        @media (min-width: 768px) {
            .grafica-barras {
                height: 350px;
                padding: 2rem;
            }
        }

        .barra {
            flex: 1;
            margin: 0 2px;
            border-radius: 8px 8px 0 0;
            position: relative;
            min-height: 5px;
            transition: transform 0.3s ease, filter 0.2s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        @media (min-width: 768px) {
            .barra {
                margin: 0 3px;
            }
        }

        .barra.low {
            background: linear-gradient(180deg, #94a3b8 0%, #64748b 100%);
        }

        .barra.medium {
            background: linear-gradient(180deg, #3b82f6 0%, #6366f1 100%);
        }

        .barra.high {
            background: linear-gradient(180deg, #10b981 0%, #059669 100%);
        }

        .barra.very-high {
            background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);
        }

        .barra:hover {
            transform: scaleX(1.15) scaleY(1.05);
            filter: brightness(1.3);
            z-index: 10;
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
        }

        .barra:active {
            transform: scale(0.95);
        }

        .barra-label {
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            color: #cbd5e1;
            font-weight: 600;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .barra-label {
                bottom: -25px;
                font-size: 0.7rem;
            }
        }

        .barra-valor {
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            color: #e2e8f0;
            font-size: 0.8rem;
            background: rgba(99, 102, 241, 0.3);
            padding: 0.125rem 0.5rem;
            border-radius: 6px;
        }

        @media (min-width: 768px) {
            .barra-valor {
                top: -25px;
                font-size: 0.9rem;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }
            #detalle-content, #detalle-content * {
                visibility: visible;
            }
            #detalle-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                padding: 0;
                box-shadow: none;
            }
            .hidden-print, .btn-hamburguesa {
                display: none !important;
            }
            body {
                background: white;
                color: #000 !important;
            }
            body::before {
                display: none;
            }
            .card {
                box-shadow: none;
                border: 1px solid #e2e8f0;
                background: white;
            }
            .card h2, .header h1, .item-price, .card *, #detalle-content * {
                -webkit-text-fill-color: #000 !important;
                color: #000 !important;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.5);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.7);
        }

        select option {
            background: #1e1b4b;
            color: #e2e8f0;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            width: 100%;
        }

        @media (min-width: 768px) {
            .header-actions {
                gap: 1rem;
                width: auto;
                flex-wrap: nowrap;
            }
        }

        .header-actions .btn {
            flex: 1;
            min-width: 0;
        }

        @media (min-width: 768px) {
            .header-actions .btn {
                flex: initial;
            }
        }

        @media (max-width: 640px) {
            .hide-mobile {
                display: none;
            }
            
            .tabla th.hide-mobile,
            .tabla td.hide-mobile {
                display: none;
            }
            
            .show-mobile {
                display: block !important;
            }
        }

        @media (min-width: 641px) {
            .show-mobile {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    
    <button class="btn-hamburguesa" onclick="toggleMenu()">
        <span></span>
    </button>

    <div class="menu-overlay" id="menu-overlay" onclick="toggleMenu()"></div>
    <div class="menu-lateral" id="menu-lateral">
        <div class="menu-header">
            <h2>ü™ü Canotex</h2>
            <p style="color: #94a3b8; font-size: 0.875rem; margin-top: 0.5rem;">Men√∫ de navegaci√≥n</p>
        </div>

        <div class="menu-content">
            <div class="menu-item" onclick="mostrarVista('dashboard'); toggleMenu();">
                üè† Dashboard Principal
            </div>
            <div class="menu-item" onclick="mostrarVista('gestion'); toggleMenu();">
                üìã Gesti√≥n de Presupuestos
            </div>
            <div class="menu-item" onclick="mostrarVista('grafica'); toggleMenu();">
                üìä Gr√°fica Mensual
            </div>
        </div>

        <div class="menu-footer">
            <button class="btn btn-primary" onclick="enviarEmailAyuda()" style="width: 100%;">
                üìß Ayuda
            </button>
            <button class="btn btn-secondary" onclick="window.location.reload();" style="width: 100%;">
                üîÑ Recargar App
            </button>
        </div>
    </div>

    <div class="container">
        <!-- DASHBOARD VIEW -->
        <div id="dashboard-view" class="fade-in">
            <div class="header">
                <div style="text-align: center; flex: 1;">
                    <h1>ü™ü Sistema de Presupuestos</h1>
                    <p style="color: #94a3b8; margin-top: 0.5rem; font-size: 0.85rem;">Gesti√≥n profesional de presupuestos de cortinas</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" id="btn-nuevo" onclick="mostrarVista('nuevo')">
                        ‚ûï <span class="hide-mobile">Nuevo </span>Presupuesto
                    </button>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card clickable" onclick="mostrarGraficaMensual()">
                    <h3>üìà Total Presupuestos</h3>
                    <div class="value" id="total-presupuestos">0</div>
                    <p style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.85;">Click para ver gr√°fica mensual</p>
                </div>
                <div class="stat-card clickable"
                    style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.25) 0%, rgba(124, 58, 237, 0.25) 100%); border-color: rgba(139, 92, 246, 0.4);"
                    onclick="mostrarPresupuestosDelMes()">
                    <h3>üìÖ Este Mes</h3>
                    <div class="value" id="total-mes">0</div>
                    <p style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.85;">Click para ver detalles del mes</p>
                </div>
            </div>
            
            <div class="card">
                <h2>üìã Presupuestos Recientes</h2>
                <div class="tabla-wrapper">
                    <table class="tabla" id="tabla-presupuestos">
                        <thead>
                            <tr>
                                <th>N¬∫</th>
                                <th>Cliente</th>
                                <th class="hide-mobile">Fecha</th>
                                <th class="hide-mobile">Items</th>
                                <th style="text-align: right;">Total</th>
                                <th style="text-align: center;">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2.5rem; color: #64748b;">
                                    No hay presupuestos. ¬°Crea el primero!
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- NUEVO PRESUPUESTO VIEW -->
        <div id="nuevo-view" class="hidden">
            <div class="header">
                <div style="display: flex; align-items: center; gap: 0.75rem; width: 100%;">
                    <button class="btn btn-secondary" onclick="mostrarVista('dashboard')" style="flex-shrink: 0;">
                        ‚Üê <span class="hide-mobile">Volver</span>
                    </button>
                    <h1 style="font-size: 1.25rem;">Nuevo Presupuesto</h1>
                </div>
            </div>

            <div class="grid grid-2">
                <div>
                    <div class="card">
                        <h2>üë§ Datos del Cliente</h2>
                        <div class="form-group">
                            <label>Nombre del Cliente *</label>
                            <input type="text" id="cliente-nombre" placeholder="Nombre completo">
                        </div>
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label>Tel√©fono</label>
                                <input type="tel" id="cliente-telefono" placeholder="+34 600 000 000">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="cliente-email" placeholder="cliente@email.com">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Direcci√≥n</label>
                            <input type="text" id="cliente-direccion" placeholder="Calle, n√∫mero, ciudad">
                        </div>
                    </div>

                    <div class="card">
                        <h2>üßÆ Calculadora de Cortinas</h2>

                        <div class="step-box step-blue">
                            <div class="step-header">
                                <div class="step-number">1</div>
                                <div class="step-title">Tipo y Tejido</div>
                            </div>

                            <div class="form-group">
                                <label>Tipo de Cortina *</label>
                                <select id="tipo-cortina">
                                    <option value="">Selecciona el tipo...</option>
                                    <option value="estor_paquetto">Estor Paquetto (sin varillas)</option>
                                    <option value="estor_plegable">Estor Plegable (con varillas)</option>
                                    <option value="cortina_onda_perfecta">Cortina Onda Perfecta</option>
                                    <option value="cortina_fruncida">Cortina Fruncida</option>
                                    <option value="cortina_plana">Cortina Plana sin Frunce</option>
                                    <option value="cortina_ollados">Cortina con Ollados</option>
                                    <option value="cortina_triple_pliegue">Cortina Triple Pliegue</option>
                                    <option value="cortina_palas">Cortina Palas</option>
                                    <option value="cortina_plana_doble">Cortina Plana Doble Tejido</option>
                                    <option value="cortina_plegones">Cortina Plegones</option>
                                </select>
                            </div>

                            <div class="form-group" style="z-index: 10000; position: relative;">
                                <label>Tejido * <small>(Buscar por nombre)</small></label>
                                <div class="search-box">
                                    <input type="text" id="tejido-search" placeholder="Buscar tejido..."
                                        oninput="buscarTejido()">
                                    <div id="search-results" class="search-results hidden"></div>
                                </div>
                                <input type="hidden" id="tejido">
                            </div>

                            <div id="color-container" style="display: none;"></div>
                        </div>
                    
                        <div class="step-box step-purple">
                            <div class="step-header">
                                <div class="step-number">2</div>
                                <div class="step-title">üìè Medidas</div>
                            </div>

                            <div class="grid grid-2">
                                <div class="form-group">
                                    <label>Ancho (cm) *</label>
                                    <input type="number" id="ancho" placeholder="200">
                                </div>
                                <div class="form-group">
                                    <label>Alto (cm) *</label>
                                    <input type="number" id="alto" placeholder="280">
                                </div>
                            </div>

                            <div class="checkbox-container">
                                <input type="checkbox" id="dos-piezas">
                                <label for="dos-piezas">‚úÇÔ∏è Dividir en 2 piezas</label>
                            </div>
                        </div>

                        <div class="step-box step-amber">
                            <div class="step-header">
                                <div class="step-number">3</div>
                                <div class="step-title">üîß Sistema</div>
                            </div>

                            <div class="form-group">
                                <label>Sistema (opcional)</label>
                                <select id="sistema" onchange="mostrarOpcionesBarras()">
                                    <option value="">Sin sistema</option>
                                </select>
                            </div>

                            <div id="opciones-barras" style="display: none;">
                                <div class="form-group" id="diametro-container">
                                    <label>Di√°metro</label>
                                    <select id="diametro-barra">
                                        <option value="">Selecciona...</option>
                                        <option value="20">20mm</option>
                                        <option value="28">28mm</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Medida</label>
                                    <select id="medida-barra">
                                        <option value="">Selecciona...</option>
                                        <option value="150">150cm</option>
                                        <option value="200">200cm</option>
                                        <option value="250">250cm</option>
                                        <option value="300">300cm</option>
                                    </select>
                                </div>
                            </div>

                            <div class="checkbox-container">
                                <input type="checkbox" id="incluir-instalacion">
                                <label for="incluir-instalacion">üîß Incluir instalaci√≥n (+50‚Ç¨)</label>
                            </div>
                        </div>

                        <button class="btn btn-success" onclick="agregarItem()"
                            style="width: 100%; padding: 1rem; font-size: 1.05rem;">
                            <span id="btn-texto">‚ûï Agregar al Presupuesto</span>
                        </button>
                    </div>

                    <div class="card" id="items-card" style="display: none;">
                        <h2>üì¶ Items del Presupuesto</h2>
                        <div class="item-list" id="items-list"></div>
                    </div>

                    <div class="card">
                        <h2>üìù Notas Adicionales</h2>
                        <div class="form-group">
                            <textarea id="notas" rows="4"
                                placeholder="A√±ade cualquier informaci√≥n adicional..."></textarea>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="resumen">
                        <h3>üì¶ Resumen del Presupuesto</h3>
                        <div class="resumen-linea">
                            <span>Total Items:</span>
                            <span id="total-items">0</span>
                        </div>
                        <div class="resumen-linea">
                            <span>Subtotal (sin IVA):</span>
                            <span id="subtotal">0.00‚Ç¨</span>
                        </div>
                        <div class="resumen-linea">
                            <span>IVA (21%):</span>
                            <span id="iva">0.00‚Ç¨</span>
                        </div>
                        <div class="resumen-total">
                            <div style="display: flex; justify-content: space-between;">
                                <span>TOTAL:</span>
                                <span id="total">0.00‚Ç¨</span>
                            </div>
                        </div>
                        <button class="btn" onclick="guardarPresupuesto()"
                            style="width: 100%; background: white; color: #2563eb; margin-top: 1.5rem; font-weight: bold; padding: 1rem;">
                            üíæ Guardar Presupuesto
                        </button>
                        <button class="btn" onclick="guardarBorrador()"
                            style="width: 100%; margin-top: 0.75rem; background: rgba(245, 158, 11, 0.2); color: #fbbf24; border-color: rgba(245, 158, 11, 0.3);">
                            üìù Guardar Borrador
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- DETALLE VIEW -->
        <div id="detalle-view" class="hidden">
            <div class="header hidden-print">
                <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
                    <button class="btn btn-secondary" onclick="mostrarVista('dashboard')">
                        ‚Üê <span class="hide-mobile">Volver</span>
                    </button>
                    <h1 style="font-size: 1.25rem;">Detalle del Presupuesto</h1>
                </div>
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <button class="btn btn-primary hidden-print" onclick="window.print()">
                        üñ®Ô∏è <span class="hide-mobile">Imprimir</span>
                    </button>
                    <button class="btn btn-success hidden-print" onclick="generarYEnviarPDF()">
                        üìß <span class="hide-mobile">Enviar PDF</span>
                    </button>
                </div>
            </div>

            <div class="card" id="detalle-content"></div>
        </div>

        <!-- GESTION VIEW -->
        <div id="gestion-view" class="hidden">
            <div class="header">
                <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
                    <button class="btn btn-secondary" onclick="mostrarVista('dashboard')">
                        ‚Üê <span class="hide-mobile">Volver</span>
                    </button>
                    <h1 style="font-size: 1.25rem;">Gesti√≥n de Presupuestos</h1>
                </div>
            </div>

            <div class="card">
                <h2>üîç Filtros</h2>
                <div class="filtros-gestion">
                    <div class="form-group">
                        <label>Buscar por nombre</label>
                        <input type="text" id="filtro-nombre" placeholder="Nombre del cliente..."
                            oninput="filtrarPresupuestos()">
                    </div>
                    <div class="form-group">
                        <label>Buscar por n√∫mero</label>
                        <input type="text" id="filtro-numero" placeholder="N√∫mero..."
                            oninput="filtrarPresupuestos()">
                    </div>
                    <div class="form-group">
                        <label>Fecha desde</label>
                        <input type="date" id="filtro-fecha-desde" onchange="filtrarPresupuestos()">
                    </div>
                    <div class="form-group">
                        <label>Fecha hasta</label>
                        <input type="date" id="filtro-fecha-hasta" onchange="filtrarPresupuestos()">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìä Resultados (<span id="total-resultados">0</span>)</h2>
                <div class="tabla-wrapper">
                    <table class="tabla">
                        <thead>
                            <tr>
                                <th>N¬∫</th>
                                <th>Cliente</th>
                                <th class="hide-mobile">Fecha</th>
                                <th class="hide-mobile">Items</th>
                                <th style="text-align: right;">Total</th>
                                <th style="text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-gestion-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- GRAFICA VIEW -->
        <div id="grafica-view" class="hidden">
            <div class="header">
                <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
                    <button class="btn btn-secondary" onclick="mostrarVista('dashboard')">
                        ‚Üê <span class="hide-mobile">Volver</span>
                    </button>
                    <h1 style="font-size: 1.25rem;">Presupuestos por Mes</h1>
                </div>
            </div>

            <div class="grafica-container">
                <h2 style="color: #e2e8f0; margin-bottom: 1.5rem; font-size: 1.25rem; background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üìä Presupuestos Mensuales - <span id="anio-actual">2026</span></h2>
                <div class="grafica-barras" id="grafica-barras"></div>
                <p style="text-align: center; margin-top: 2rem; color: #94a3b8; font-size: 0.85rem;">
                    üí° Click en cualquier barra para ver los presupuestos de ese mes
                </p>
            </div>
        </div>
    </div>
    
    <script>
        const TEJIDOS = [
            { nombre: "AALBORG 60-61-64", precio: 57.68, ancho: 300, composicion: "53% Pes 47% Li" },
            { nombre: "AALBORG 90-91-94", precio: 57.68, ancho: 300, composicion: "57% Pes 43% Li" },
            { nombre: "ABI", precio: 35.13, ancho: 300, composicion: "100% Pes" },
            { nombre: "ACHIRA", precio: 42.25, ancho: 315, composicion: "100% Pes" },
            { nombre: "AKINA", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "ALCACERES", precio: 51.45, ancho: 315, composicion: "100% Pes" },
            { nombre: "ALFA", precio: 33.26, ancho: 140, composicion: "100% Pol" },
            { nombre: "ALIDA GRIS", precio: 48.62, ancho: 280, composicion: "70% Alg 30% Pes" },
            { nombre: "ALISHA", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "ALISON", precio: 31.35, ancho: 140, composicion: "100% Pes" },
            { nombre: "AMETISTA", precio: 39.20, ancho: 300, composicion: "100% Pes" },
            { nombre: "ANEKO", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "ANETO", precio: 38.40, ancho: 300, composicion: "100%Pes" },
            { nombre: "ANOUK GRIS", precio: 48.62, ancho: 280, composicion: "70% Alg 30% Pes" },
            { nombre: "APATITE", precio: 39.20, ancho: 300, composicion: "100% Pes" },
            { nombre: "ARACHOVA", precio: 44.52, ancho: 280, composicion: "60% Pes 20% Co 20% PAN" },
            { nombre: "ARNIKA", precio: 45.36, ancho: 295, composicion: "18%Li 82% Pes" },
            { nombre: "ASA", precio: 50.63, ancho: 310, composicion: "88%PES-12%CO" },
            { nombre: "ASLAN", precio: 35.13, ancho: 300, composicion: "100%Pes" },
            { nombre: "ASPEN BCO/CRUDO", precio: 51.10, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "ASPEN LINO", precio: 51.10, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "ASTIN GRIS", precio: 48.62, ancho: 280, composicion: "70% Alg 30% Pes" },
            { nombre: "ASTRID", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "ASTUN", precio: 33.41, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "AZAD", precio: 35.13, ancho: 300, composicion: "80% Pes 20% Li" },
            { nombre: "AZAMI", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "BAMBERG", precio: 48.72, ancho: 140, composicion: "100% Pol" },
            { nombre: "BAVAY", precio: 51.10, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "BEGUR", precio: 45.68, ancho: 300, composicion: "60% Pes 40% Li" },
            { nombre: "BERLIN", precio: 31.40, ancho: 140, composicion: "100% Pes" },
            { nombre: "BETA", precio: 33.26, ancho: 140, composicion: "100% Pol" },
            { nombre: "BIBLOS", precio: 37.52, ancho: 300, composicion: "80% Pes 20% Li" },
            { nombre: "BINDY", precio: 54.99, ancho: 310, composicion: "62%PES-38%PAN" },
            { nombre: "BLITZ", precio: 54.88, ancho: 300, composicion: "58% Pes 42% Li" },
            { nombre: "BOLLY", precio: 35.46, ancho: 310, composicion: "95%PES-5%CO" },
            { nombre: "BONIFACIO", precio: 45.68, ancho: 300, composicion: "60% Pes 40% Li" },
            { nombre: "BONN", precio: 48.72, ancho: 140, composicion: "8% Li 92% Pes" },
            { nombre: "BREMEN", precio: 42.33, ancho: 140, composicion: "100% Pol" },
            { nombre: "BRERA", precio: 42.53, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "BRISA", precio: 64.68, ancho: 310, composicion: "97%PES 3%CO" },
            { nombre: "BUBBLES", precio: 48.56, ancho: 280, composicion: "50% Pes 50% Co" },
            { nombre: "CALVI", precio: 42.53, ancho: 300, composicion: "50% Li 50% Pes" },
            { nombre: "CANNES", precio: 35.96, ancho: 140, composicion: "100% Pes" },
            { nombre: "CANVAS", precio: 59.22, ancho: 310, composicion: "50 % Li 50 % Co" },
            { nombre: "CARLOTA", precio: 40.70, ancho: 300, composicion: "100% Pes" },
            { nombre: "CASSIS", precio: 36.57, ancho: 300, composicion: "50% Li 50% Pes" },
            { nombre: "CATIONIC PLANA", precio: 42.57, ancho: 300, composicion: "100% Pol" },
            { nombre: "CATIONIC SARGA", precio: 42.57, ancho: 300, composicion: "100% Pol" },
            { nombre: "CHATEAU", precio: 51.45, ancho: 310, composicion: "100% Pes" },
            { nombre: "CIARA", precio: 50.63, ancho: 310, composicion: "88%PES-12%CO" },
            { nombre: "CIVITA", precio: 48.58, ancho: 300, composicion: "28% Pes 60% Co 12% Li" },
            { nombre: "COLONIA", precio: 31.40, ancho: 140, composicion: "100% Pes" },
            { nombre: "CONCHA", precio: 41.11, ancho: 300, composicion: "70% Pol 30% Li" },
            { nombre: "COSAMOC", precio: 55.48, ancho: 280, composicion: "45% Pes 52% Alg 3% Li" },
            { nombre: "COTICA", precio: 55.48, ancho: 280, composicion: "45% Pes 52% Alg 3% Li" },
            { nombre: "DESIGN", precio: 52.07, ancho: 280, composicion: "40% Pes 40% Co 20% Pac" },
            { nombre: "DEVA", precio: 116.98, ancho: 300, composicion: "43%LI-40%CV-17%WO" },
            { nombre: "DIAMANTE", precio: 39.20, ancho: 300, composicion: "9 % Acr 91 % Pes" },
            { nombre: "DILARA", precio: 39.06, ancho: 300, composicion: "100% Pes" },
            { nombre: "DORTMUND", precio: 42.33, ancho: 140, composicion: "100% Pol" },
            { nombre: "DRESDEN", precio: 48.72, ancho: 140, composicion: "42% Acr 58% Pes" },
            { nombre: "ELISE BCO/CRUDO", precio: 33.40, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "ELISE LINO", precio: 33.40, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "ELMA", precio: 41.58, ancho: 300, composicion: "100% Pes" },
            { nombre: "ENDER", precio: 39.06, ancho: 300, composicion: "100% Pes" },
            { nombre: "ESPIGA", precio: 52.70, ancho: 280, composicion: "65% Pes 35% Co" },
            { nombre: "EWAN", precio: 31.35, ancho: 140, composicion: "100% Pes" },
            { nombre: "FLAT", precio: 34.24, ancho: 140, composicion: "100% Pes" },
            { nombre: "FLIEDER", precio: 73.50, ancho: 290, composicion: "60% CV 25% Li 15% Pes" },
            { nombre: "FLORAL", precio: 52.70, ancho: 280, composicion: "65% Pes 35% Co" },
            { nombre: "FORNELLS", precio: 41.11, ancho: 300, composicion: "65% Pol 35% Li" },
            { nombre: "FUJI", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "GAMMA", precio: 33.26, ancho: 140, composicion: "100% Pol" },
            { nombre: "GEN", precio: 50.63, ancho: 300, composicion: "100% PES" },
            { nombre: "GINEBRA", precio: 40.70, ancho: 300, composicion: "100% Pes" },
            { nombre: "GLAT", precio: 47.31, ancho: 315, composicion: "100% Pes Ignifugo" },
            { nombre: "GORBEA", precio: 35.12, ancho: 300, composicion: "100%Pes" },
            { nombre: "HAMLET", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "HANOVER", precio: 31.40, ancho: 140, composicion: "100% Pes" },
            { nombre: "HYDRA", precio: 44.52, ancho: 280, composicion: "60% Pes 20% Co 20% PAN" },
            { nombre: "IBOR", precio: 42.15, ancho: 140, composicion: "56% Alg 4% Li 12% Pol 28% Acr" },
            { nombre: "IMA", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "INDIRA", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "JANIN", precio: 50.04, ancho: 300, composicion: "66%PES-34%CV" },
            { nombre: "JIN", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "KALIA", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "KAMILLE", precio: 36.10, ancho: 305, composicion: "100% Pes" },
            { nombre: "KATY", precio: 50.04, ancho: 300, composicion: "78%PES-22%LI" },
            { nombre: "KEIKO", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "KEREN", precio: 35.13, ancho: 300, composicion: "100% Pes" },
            { nombre: "KHAN", precio: 35.13, ancho: 290, composicion: "92% Pes 8% Cv" },
            { nombre: "KIMI", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "KURVEN", precio: 122.75, ancho: 275, composicion: "100 % Li" },
            { nombre: "LEGI", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "LIMENI", precio: 44.52, ancho: 280, composicion: "60% CV 25% Li 15% Pes" },
            { nombre: "LINDAU", precio: 42.33, ancho: 140, composicion: "100% Pol" },
            { nombre: "LINE", precio: 47.31, ancho: 315, composicion: "100% Pes Ignifugo" },
            { nombre: "LINETTE BLACKOUT", precio: 66.08, ancho: 290, composicion: "Blackout" },
            { nombre: "LINSE", precio: 61.66, ancho: 290, composicion: "60% CV 25% Li 15% Pes" },
            { nombre: "LOCA", precio: 50.04, ancho: 280, composicion: "90%CV- 10%PES" },
            { nombre: "LOGAN", precio: 31.35, ancho: 140, composicion: "100% Pes" },
            { nombre: "LOIRA", precio: 49.65, ancho: 320, composicion: "100% Pol" },
            { nombre: "LOUTROS", precio: 44.52, ancho: 280, composicion: "60% Pes 20% Co 20% PAN" },
            { nombre: "LUBECA", precio: 42.33, ancho: 140, composicion: "100% Pol" },
            { nombre: "LULI", precio: 50.04, ancho: 300, composicion: "100% PES" },
            { nombre: "LUZZI", precio: 47.63, ancho: 300, composicion: "80% Pes 20% Li" },
            { nombre: "MALADETA", precio: 36.23, ancho: 300, composicion: "100%Pes" },
            { nombre: "MATI", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "MAVI", precio: 44.66, ancho: 300, composicion: "94% Pes 4% Co 2% Li" },
            { nombre: "MEISSEN", precio: 42.33, ancho: 140, composicion: "100% Pol" },
            { nombre: "MENTON", precio: 51.10, ancho: 300, composicion: "50% Li 50% Pes" },
            { nombre: "MERON", precio: 41.11, ancho: 300, composicion: "70% Pol 30% Li" },
            { nombre: "MESH", precio: 89.60, ancho: 300, composicion: "52% Li 48% Pes" },
            { nombre: "MESQUIDA", precio: 45.27, ancho: 300, composicion: "60% Pol 40% Li" },
            { nombre: "MIDORI", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "MIKA", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "MILAN BCO/CRUDO", precio: 45.68, ancho: 300, composicion: "60% Pes 40% Li" },
            { nombre: "MOIRA", precio: 31.35, ancho: 140, composicion: "100% Pes" },
            { nombre: "MONET", precio: 56.70, ancho: 300, composicion: "3% Li 97% Pes" },
            { nombre: "MONSUL", precio: 41.11, ancho: 300, composicion: "90% Pol 10% Li" },
            { nombre: "MOOT", precio: 60.38, ancho: 280, composicion: "50% Li 30% Co 20% Pes" },
            { nombre: "MORITZ", precio: 36.57, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "MULHACEN", precio: 38.40, ancho: 300, composicion: "100%Pes" },
            { nombre: "MULIAN", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "MUNICH", precio: 31.40, ancho: 140, composicion: "100% Pes" },
            { nombre: "NAOKO", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "NAPOLES", precio: 41.58, ancho: 280, composicion: "40% Pes 30% Pan 30% Co" },
            { nombre: "NARA", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "NAUPLIA", precio: 44.52, ancho: 280, composicion: "60% Pes 20% Co 20% PAN" },
            { nombre: "NELKE", precio: 60.62, ancho: 290, composicion: "60% CV 25% Li 15% Pes" },
            { nombre: "NEUTRA", precio: 33.40, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "NEYLAN", precio: 35.13, ancho: 300, composicion: "100% Pes" },
            { nombre: "NICE", precio: 34.24, ancho: 140, composicion: "100% Pes" },
            { nombre: "NIKI", precio: 50.04, ancho: 280, composicion: "90%CV- 10%PES" },
            { nombre: "NOGALES", precio: 51.35, ancho: 310, composicion: "100% Li" },
            { nombre: "NOMI", precio: 54.04, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "OMEGA", precio: 33.26, ancho: 140, composicion: "100% Pol" },
            { nombre: "ONDAS", precio: 52.70, ancho: 280, composicion: "65% Pes 35% Co" },
            { nombre: "ONUR", precio: 46.89, ancho: 315, composicion: "53% Pan 47% Pes" },
            { nombre: "OPERA", precio: 93.83, ancho: 310, composicion: "100% Li" },
            { nombre: "ORZAN", precio: 44.43, ancho: 300, composicion: "70% Pol 30% Li" },
            { nombre: "PAINE", precio: 47.60, ancho: 280, composicion: "100% Pes" },
            { nombre: "PALOMA", precio: 45.37, ancho: 320, composicion: "35% Pol 65% Li" },
            { nombre: "PANDORA", precio: 50.04, ancho: 300, composicion: "90%CV- 10%PES" },
            { nombre: "PAPAGAYO", precio: 41.11, ancho: 300, composicion: "80% Pol 20% Li" },
            { nombre: "PAPINGO", precio: 44.52, ancho: 280, composicion: "60% Pes 20% Co 20% PAN" },
            { nombre: "PERDI", precio: 40.06, ancho: 310, composicion: "77%PAN-20%PES-3%PA" },
            { nombre: "PLAIN", precio: 62.86, ancho: 280, composicion: "65% Li 25% Co 10% Pes" },
            { nombre: "POINT", precio: 37.32, ancho: 140, composicion: "100% Pes" },
            { nombre: "PROVENCAL AZUL", precio: 48.62, ancho: 280, composicion: "70% Alg 30% Pes" },
            { nombre: "PROVENCAL GRIS", precio: 48.62, ancho: 280, composicion: "70% Alg 30% Pes" },
            { nombre: "PROVENCAL ROJO", precio: 48.62, ancho: 280, composicion: "70% Alg 30% Pes" },
            { nombre: "PUNKE", precio: 47.31, ancho: 315, composicion: "100% Pes Ignifugo" },
            { nombre: "RACK", precio: 25.34, ancho: 300, composicion: "100% Pes" },
            { nombre: "RALPH BCO/CRUDO", precio: 68.40, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "RALPH LINO", precio: 70.59, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "RATISBONA", precio: 42.33, ancho: 140, composicion: "100% Pol" },
            { nombre: "RAU", precio: 50.12, ancho: 280, composicion: "75% Co 25% Pes" },
            { nombre: "REINA", precio: 74.94, ancho: 315, composicion: "94%PES- 6%CV" },
            { nombre: "RETINO", precio: 44.52, ancho: 280, composicion: "60% Pes 20% Co 20% PAN" },
            { nombre: "ROMA", precio: 41.58, ancho: 280, composicion: "40% Pes 30% Pan 30% Co" },
            { nombre: "ROMBO", precio: 52.70, ancho: 280, composicion: "65% Pes 35% Co" },
            { nombre: "ROMBUS", precio: 100.38, ancho: 290, composicion: "100 % Li" },
            { nombre: "RUBINO", precio: 39.20, ancho: 300, composicion: "100% Pes" },
            { nombre: "SALADA", precio: 44.43, ancho: 320, composicion: "60% Pol 40% Li" },
            { nombre: "SAONA", precio: 41.11, ancho: 300, composicion: "80% Pol 20% Li" },
            { nombre: "SAURA", precio: 41.11, ancho: 295, composicion: "85% Pol 15% Li" },
            { nombre: "SCOTT", precio: 31.35, ancho: 140, composicion: "100% Pes" },
            { nombre: "SELIN", precio: 35.13, ancho: 300, composicion: "80% Pes 20% Li" },
            { nombre: "SHIELD", precio: 60.38, ancho: 280, composicion: "50% Li 30% Co 20% Pes" },
            { nombre: "SISUCA", precio: 48.27, ancho: 310, composicion: "67%PAN-26%PES-7%PA" },
            { nombre: "SMERALDO", precio: 40.93, ancho: 300, composicion: "100% Pes" },
            { nombre: "SMOOTH", precio: 88.20, ancho: 280, composicion: "100 % Li" },
            { nombre: "SOFT", precio: 54.68, ancho: 310, composicion: "77% Trev 23% Pes" },
            { nombre: "SOTAVENTO", precio: 41.11, ancho: 315, composicion: "80% Pol 20% Li" },
            { nombre: "STAR", precio: 48.56, ancho: 280, composicion: "50% Pes 50% Co" },
            { nombre: "STICK", precio: 48.56, ancho: 280, composicion: "50% Pes 50% Co" },
            { nombre: "STILO", precio: 68.65, ancho: 295, composicion: "80% Vis 20% Li" },
            { nombre: "STUTGART", precio: 39.20, ancho: 140, composicion: "100% Pol" },
            { nombre: "SWEET", precio: 25.34, ancho: 310, composicion: "100 % Pes ignifug" },
            { nombre: "SYMI", precio: 44.52, ancho: 280, composicion: "60% Pes 20% Co 20% PAN" },
            { nombre: "TANG", precio: 78.68, ancho: 290, composicion: "55% Li 30% Co 20% Pes" },
            { nombre: "TEIDE", precio: 36.23, ancho: 300, composicion: "100%Pes" },
            { nombre: "TERA", precio: 42.15, ancho: 140, composicion: "56% Alg 4% Li 12% Pol 28% Acr" },
            { nombre: "TERESITAS", precio: 44.43, ancho: 320, composicion: "60% Pol 40% Li" },
            { nombre: "TIM", precio: 57.26, ancho: 290, composicion: "65% Li 25% Co 10% Pes" },
            { nombre: "TORTORA", precio: 45.89, ancho: 310, composicion: "60%PES-40%LI" },
            { nombre: "TRAUBE", precio: 73.50, ancho: 290, composicion: "60% CV 25% Li 15% Pes" },
            { nombre: "TRAUM", precio: 71.37, ancho: 290, composicion: "100% Li" },
            { nombre: "TREVERIS", precio: 48.32, ancho: 140, composicion: "5% Li 95% Pes" },
            { nombre: "VELLUTO", precio: 48.51, ancho: 280, composicion: "100% Pes" },
            { nombre: "VENECIA", precio: 41.58, ancho: 280, composicion: "40% Pes 30% Pan 30% Co" },
            { nombre: "XARCO", precio: 32.79, ancho: 350, composicion: "90% Pol 10% Li" },
            { nombre: "YECLA 01-02-03", precio: 47.88, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "YECLA 11-12-13", precio: 47.88, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "YECLA 41-42-43", precio: 47.88, ancho: 310, composicion: "50% Pes 50% Li" },
            { nombre: "YECLA 51-52-53", precio: 47.88, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "ZAHARA", precio: 41.11, ancho: 300, composicion: "90% Pol 10% Li" }
        ];

        const COLORES_TEJIDOS = {
            "AALBORG 60-61-64": ["60 Beige", "61 Gris", "64 Azul"],
            "AALBORG 90-91-94": ["90 Blanco", "91 Crema", "94 Verde"],
            "ABI": ["01 Blanco", "02 Crudo", "03 Beige", "04 Gris", "05 Azul", "06 Verde"],
            "ACHIRA": ["01 Natural", "02 Arena", "03 Piedra", "04 Gris"],
            "AKINA": ["01 Blanco", "02 Beige", "03 Gris", "04 Azul"],
            "ALIDA GRIS": ["Gris"],
            "ALISHA": ["01 Blanco", "02 Beige", "03 Gris"],
            "ANOUK GRIS": ["Gris"],
            "ASPEN BCO/CRUDO": ["Blanco", "Crudo"],
            "ASPEN LINO": ["Lino Natural"],
            "ASTIN GRIS": ["Gris"],
            "ELISE BCO/CRUDO": ["Blanco", "Crudo"],
            "ELISE LINO": ["Lino Natural"],
            "LINETTE BLACKOUT": ["01 Blanco", "02 Beige", "03 Gris", "04 Negro"],
            "MILAN BCO/CRUDO": ["Blanco", "Crudo"],
            "PROVENCAL AZUL": ["Azul"],
            "PROVENCAL GRIS": ["Gris"],
            "PROVENCAL ROJO": ["Rojo"],
            "RALPH BCO/CRUDO": ["Blanco", "Crudo"],
            "RALPH LINO": ["Lino Natural"],
            "YECLA 01-02-03": ["01 Beige", "02 Gris", "03 Azul"],
            "YECLA 11-12-13": ["11 Blanco", "12 Crema", "13 Arena"],
            "YECLA 41-42-43": ["41 Verde", "42 Azul", "43 Gris"],
            "YECLA 51-52-53": ["51 Rosa", "52 Lila", "53 Morado"],
            "default": ["Color √∫nico"]
        };

        const SISTEMAS = {
            "Estor a Cadena - Paquetto": {75:52.20, 100:57.38, 125:67.80, 150:77.19, 175:79.18, 200:88.61, 225:103.04, 250:107.97, 275:117.27, 300:126.66},
            "Estor a Cadena - Plegable": {75:54.01, 100:59.91, 125:69.94, 150:82.26, 175:89.06, 200:94.02, 225:108.11, 250:116.51, 275:128.41, 300:136.81},
            "Gu√≠a Manual 1 V√≠a - Convencional": {100:10.17, 125:12.86, 150:15.01, 175:16.74, 200:18.87, 225:20.95, 250:24.10, 275:26.42, 300:28.90},
            "Gu√≠a Manual 1 V√≠a - Onda Perfecta": {100:23.10, 125:29.03, 150:34.41, 175:39.38, 200:44.74, 225:50.06, 250:56.44, 275:61.99, 300:67.70},
            "Gu√≠a Profesional Manual - Convencional": {100:40.99, 150:55.77, 200:69.05, 250:85.07, 300:99.30},
            "Gu√≠a Profesional Manual - Onda Perfecta": {100:43.15, 150:58.72, 200:72.68, 250:89.54, 300:104.54},
            "Gu√≠a Profesional a Cord√≥n - Convencional": {100:52.53, 150:67.45, 200:81.01, 250:97.34, 300:111.90},
            "Gu√≠a Profesional a Cord√≥n - Onda Perfecta": {100:55.30, 150:70.99, 200:85.27, 250:102.46, 300:117.80},
            "Barra Gu√≠a Cuadrada - Convencional": {100:65.77, 150:79.68, 200:93.59, 250:124.26, 300:138.18},
            "Barra Gu√≠a Cuadrada - Onda Perfecta": {100:67.78, 150:82.70, 200:97.61, 250:129.29, 300:144.21},
            "Barra Gu√≠a Redonda 20mm - Convencional": {100:64.51, 150:78.17, 200:91.81, 250:121.89, 300:135.54},
            "Barra Gu√≠a Redonda 20mm - Onda Perfecta": {100:66.49, 150:81.12, 200:95.75, 250:126.82, 300:141.46},
            "Barra Gu√≠a Redonda 28mm - Convencional": {100:74.18, 150:85.98, 200:100.99, 250:134.08, 300:149.09},
            "Barra Gu√≠a Redonda 28mm - Onda Perfecta": {100:76.46, 150:93.28, 200:105.32, 250:139.51, 300:155.60},
            "Barra Forja Negra": "forja",
            "Barra Forja Blanca": "forja",
            "Barra √ìxido": "forja",
            "Barra Acero": "forja",
            "Barra Oro Viejo": "forja",
            "Barra Cuadrada con Anillas": "forja"
        };

        const PRECIOS_BARRAS = {
            "Barra Forja Negra": { "20": {150:66.96, 200:71.27, 250:95.72}, "28": {150:132.24, 200:144.75, 250:150.07} },
            "Barra Forja Blanca": { "20": {150:66.96, 200:71.27, 250:95.72}, "28": {150:132.24, 200:144.75, 250:150.07} },
            "Barra √ìxido": { "20": {150:66.96, 200:71.27, 250:95.72}, "28": {150:132.24, 200:144.75, 250:150.07} },
            "Barra Acero": { "20": {150:64.66, 200:69.02, 250:93.47}, "28": {150:134.49, 200:147.00, 250:152.33} },
            "Barra Oro Viejo": { "20": {150:76.36, 200:87.71, 250:99.68}, "28": {150:138.10, 200:150.61, 250:155.94} },
            "Barra Cuadrada con Anillas": { "√∫nico": {150:99.18, 200:108.32, 250:151.10, 300:176.21} }
        };

        const CONFECCION = {
            "estor_paquetto": {100:60.08, 150:72.10, 200:84.12, 250:96.13, 300:120.17, 350:132.18},
            "estor_plegable": {100:72.10, 150:84.12, 200:96.13, 250:108.15, 300:126.17, 350:138.20},
            "cortina_onda_perfecta": {100:43.25, 150:55.28, 200:67.29, 250:79.31, 300:91.33, 350:103.34},
            "cortina_fruncida": {100:43.25, 150:55.28, 200:67.29, 250:79.31, 300:91.33, 350:103.34},
            "cortina_plana": {100:31.24, 150:43.25, 200:55.28, 250:60.08, 300:66.09, 350:78.11},
            "cortina_ollados": {100:31.24, 150:43.25, 200:55.28, 250:60.08, 300:66.09, 350:78.11},
            "cortina_triple_pliegue": {100:56.23, 150:71.86, 200:87.48, 250:103.11, 300:118.72, 350:134.34},
            "cortina_palas": {100:43.25, 150:55.28, 200:67.29, 250:79.31, 300:91.33, 350:103.34},
            "cortina_plana_doble": {100:31.24, 150:43.25, 200:55.28, 250:60.08, 300:66.09, 350:78.11},
            "cortina_plegones": {100:43.25, 150:55.28, 200:67.29, 250:79.31, 300:91.33, 350:103.34}
        };

        const TIPOS_NOMBRE = {
            "estor_paquetto": "Estor Paquetto",
            "estor_plegable": "Estor Plegable",
            "cortina_onda_perfecta": "Cortina Onda Perfecta",
            "cortina_fruncida": "Cortina Fruncida",
            "cortina_plana": "Cortina Plana",
            "cortina_ollados": "Cortina con Ollados",
            "cortina_triple_pliegue": "Cortina Triple Pliegue",
            "cortina_palas": "Cortina Palas",
            "cortina_plana_doble": "Cortina Plana Doble Tejido",
            "cortina_plegones": "Cortina Plegones"
        };

        let itemsActuales = [];
        let editandoItemId = null;
        let editandoPresupuestoId = null;

        document.addEventListener('DOMContentLoaded', function() {
            cargarSistemas();
            cargarDashboard();
            document.getElementById('anio-actual').textContent = new Date().getFullYear();
            
            if (localStorage.getItem('borrador_presupuesto')) {
                const btnNuevo = document.getElementById('btn-nuevo');
                if (btnNuevo) {
                    btnNuevo.innerHTML = '‚ûï <span class="hide-mobile">Nuevo </span>Presupuesto <span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.7rem; margin-left: 0.5rem;">üìù</span>';
                }
            }
        });

        document.addEventListener('click', function(e) {
            const searchBox = document.querySelector('.search-box');
            if (searchBox && !searchBox.contains(e.target)) {
                const results = document.getElementById('search-results');
                if (results) {
                    results.classList.add('hidden');
                }
            }
        });

        function cargarSistemas() {
            const select = document.getElementById('tipo-cortina');
            select.addEventListener('change', filtrarSistemasPorTipo);
        }

        function filtrarSistemasPorTipo() {
            const tipo = document.getElementById('tipo-cortina').value;
            const selectSistema = document.getElementById('sistema');
            selectSistema.innerHTML = '<option value="">Sin sistema</option>';
            
            let sistemasPermitidos = [];
            
            if (tipo === 'estor_paquetto' || tipo === 'estor_plegable') {
                sistemasPermitidos = Object.keys(SISTEMAS).filter(s => s.includes('Estor a Cadena'));
            } else if (tipo === 'cortina_ollados') {
                sistemasPermitidos = Object.keys(SISTEMAS).filter(s => SISTEMAS[s] === 'forja');
            } else if (tipo === 'cortina_onda_perfecta') {
                sistemasPermitidos = Object.keys(SISTEMAS).filter(s => s.includes('Onda Perfecta'));
            } else if (tipo === 'cortina_fruncida' || tipo === 'cortina_palas' || tipo === 'cortina_triple_pliegue' || 
                    tipo === 'cortina_plana' || tipo === 'cortina_plana_doble' || tipo === 'cortina_plegones') {
                sistemasPermitidos = Object.keys(SISTEMAS).filter(s => s.includes('Convencional') || SISTEMAS[s] === 'forja');
            }
            
            sistemasPermitidos.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                selectSistema.appendChild(option);
            });
        }

        function mostrarOpcionesBarras() {
            const sistema = document.getElementById('sistema').value;
            const opcionesBarras = document.getElementById('opciones-barras');
            const diametroContainer = document.getElementById('diametro-container');
            const selectMedida = document.getElementById('medida-barra');
            
            if (SISTEMAS[sistema] === 'forja') {
                opcionesBarras.style.display = 'block';
                
                if (sistema === 'Barra Cuadrada con Anillas') {
                    diametroContainer.style.display = 'none';
                    document.getElementById('diametro-barra').value = '√∫nico';
                    if (!selectMedida.querySelector('[value="300"]')) {
                        const opt300 = document.createElement('option');
                        opt300.value = '300';
                        opt300.textContent = '300cm';
                        selectMedida.appendChild(opt300);
                    }
                } else {
                    diametroContainer.style.display = 'block';
                    document.getElementById('diametro-barra').value = '';
                    const opt300 = selectMedida.querySelector('[value="300"]');
                    if (opt300) opt300.remove();
                }
            } else {
                opcionesBarras.style.display = 'none';
                document.getElementById('diametro-barra').value = '';
                document.getElementById('medida-barra').value = '';
            }
        }

        function calcularPrecioSistema(ancho, sistemaNombre) {
            if (!sistemaNombre) return 0;
            
            if (SISTEMAS[sistemaNombre] === 'forja') {
                const diametro = document.getElementById('diametro-barra').value;
                const medida = parseInt(document.getElementById('medida-barra').value);
                
                if (!medida) return 0;
                
                const preciosBarra = PRECIOS_BARRAS[sistemaNombre];
                if (!preciosBarra) return 0;
                
                const preciosPorDiametro = preciosBarra[diametro] || preciosBarra['√∫nico'];
                if (!preciosPorDiametro) return 0;
                
                const precio = preciosPorDiametro[medida] || 0;
                
                if (ancho > 250) {
                    return precio * 2;
                }
                
                return precio;
            }
            
            const sistema = SISTEMAS[sistemaNombre];
            if (!sistema) return 0;
            
            const rangos = Object.keys(sistema).map(r => parseInt(r)).sort((a, b) => a - b);
            const rangoMaximo = rangos[rangos.length - 1];
            
            if (ancho > rangoMaximo) {
                const anchoMitad = ancho / 2;
                const rangoParaMitad = rangos.find(r => anchoMitad <= r) || rangoMaximo;
                return (sistema[rangoParaMitad] || 0) * 2;
            }
            
            const rangoAplicable = rangos.find(r => ancho <= r);
            return sistema[rangoAplicable || rangoMaximo] || 0;
        }

        function buscarTejido() {
            const searchInput = document.getElementById('tejido-search');
            const searchResults = document.getElementById('search-results');
            const query = searchInput.value.toLowerCase();
            
            if (query.length === 0) {
                searchResults.classList.add('hidden');
                return;
            }
            
            const filtered = TEJIDOS.filter(t => t.nombre.toLowerCase().includes(query));
            
            if (filtered.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item" style="text-align: center; color: #94a3b8;">No se encontraron tejidos</div>';
                searchResults.classList.remove('hidden');
                return;
            }
            
            searchResults.innerHTML = filtered.map(t => `
                <div class="search-result-item" onclick="seleccionarTejido('${t.nombre.replace(/'/g, "\\'")}')">
                    <strong>${t.nombre}</strong><br>
                    <small style="color: #94a3b8;">${t.precio}‚Ç¨/ml - ${t.composicion}</small>
                </div>
            `).join('');
            searchResults.classList.remove('hidden');
        }

        function seleccionarTejido(nombre) {
            document.getElementById('tejido-search').value = nombre;
            document.getElementById('tejido').value = nombre;
            document.getElementById('search-results').classList.add('hidden');
            
            const colores = COLORES_TEJIDOS[nombre] || COLORES_TEJIDOS["default"];
            const container = document.getElementById('color-container');
            container.innerHTML = '<label style="display: block; margin-bottom: 0.75rem; color: #cbd5e1; font-weight: 500; font-size: 0.875rem;">üé® Color del Tejido *</label>';
            
            const coloresDiv = document.createElement('div');
            coloresDiv.id = 'colores-visuales';
            
            colores.forEach(color => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'color-option';
                colorDiv.onclick = () => seleccionarColor(color);
                
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.background = getColorFromName(color);
                
                const label = document.createElement('span');
                label.textContent = color;
                label.style.flex = '1';
                label.style.fontSize = '0.9rem';
                
                colorDiv.appendChild(swatch);
                colorDiv.appendChild(label);
                coloresDiv.appendChild(colorDiv);
            });
            
            container.appendChild(coloresDiv);
            container.style.display = 'block';
            
            if (!document.getElementById('tejido-color-hidden')) {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.id = 'tejido-color-hidden';
                container.appendChild(hidden);
            }
        }

        function seleccionarColor(color) {
            if (!document.getElementById('tejido-color-hidden')) return;
            
            document.getElementById('tejido-color-hidden').value = color;
            
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            if (event && event.target) {
                const optionEl = event.target.closest('.color-option');
                if (optionEl) {
                    optionEl.classList.add('selected');
                }
            }
        }

        function getColorFromName(colorName) {
            const name = colorName.toLowerCase();
            if (name.includes('blanco') || name.includes('white')) return '#f8fafc';
            if (name.includes('negro') || name.includes('black')) return '#1e293b';
            if (name.includes('gris') || name.includes('gray')) return '#94a3b8';
            if (name.includes('beige') || name.includes('crudo')) return '#f5f5dc';
            if (name.includes('azul') || name.includes('blue')) return '#3b82f6';
            if (name.includes('verde') || name.includes('green')) return '#10b981';
            if (name.includes('rojo') || name.includes('red')) return '#ef4444';
            if (name.includes('rosa') || name.includes('pink')) return '#ec4899';
            if (name.includes('morado') || name.includes('purple') || name.includes('lila')) return '#a855f7';
            if (name.includes('arena') || name.includes('sand')) return '#e7d4b5';
            if (name.includes('piedra') || name.includes('stone')) return '#a8a29e';
            if (name.includes('natural') || name.includes('lino')) return '#f5f1e8';
            if (name.includes('crema') || name.includes('cream')) return '#fffbeb';
            if (name.includes('consultar')) return '#cbd5e1';
            return '#cbd5e1';
        }

        function mostrarVista(vista) {
            const vistas = ['dashboard-view', 'nuevo-view', 'detalle-view', 'gestion-view', 'grafica-view'];
            vistas.forEach(v => {
                const elemento = document.getElementById(v);
                if (elemento) {
                    elemento.classList.add('hidden');
                    elemento.classList.remove('fade-in');
                }
            });
            
            const vistaEl = document.getElementById(vista + '-view');
            if (!vistaEl) return;
            
            vistaEl.classList.remove('hidden');
            vistaEl.classList.add('fade-in');
            
            if (vista === 'dashboard') {
                cargarDashboard();
            } else if (vista === 'nuevo') {
                if (!editandoPresupuestoId) {
                    const hayBorrador = cargarBorrador();
                    if (!hayBorrador) {
                        limpiarFormulario();
                    }
                }
                const btnGuardar = document.querySelector('button[onclick="guardarPresupuesto()"]');
                if (btnGuardar && !editandoPresupuestoId) {
                    btnGuardar.innerHTML = 'üíæ Guardar Presupuesto';
                    btnGuardar.style.background = 'white';
                    btnGuardar.style.color = '#2563eb';
                }
            } else if (vista === 'gestion') {
                cargarGestion();
            } else if (vista === 'grafica') {
                cargarGraficaMensual();
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function agregarItem() {
            const tipo = document.getElementById('tipo-cortina').value;
            const ancho = parseFloat(document.getElementById('ancho').value);
            const alto = parseFloat(document.getElementById('alto').value);
            const tejidoNombre = document.getElementById('tejido').value;
            const tejidoColorEl = document.getElementById('tejido-color-hidden');
            const tejidoColor = tejidoColorEl ? tejidoColorEl.value : '';
            const sistemaNombre = document.getElementById('sistema').value;
            const dosPiezas = document.getElementById('dos-piezas').checked;

            if (!tipo || !ancho || !alto || !tejidoNombre || !tejidoColor) {
                alert('Por favor completa todos los campos obligatorios (incluido el color del tejido)');
                return;
            }

            let sistemaNombreCompleto = sistemaNombre || 'Sin sistema';

            if (sistemaNombre && SISTEMAS[sistemaNombre] === 'forja') {
                const diametro = document.getElementById('diametro-barra').value;
                const medida = document.getElementById('medida-barra').value;

                if (sistemaNombre !== 'Barra Cuadrada con Anillas') {
                    if (!diametro || !medida) {
                        alert('Por favor selecciona el di√°metro y medida de la barra');
                        return;
                    }
                    sistemaNombreCompleto = `${sistemaNombre} ${diametro}mm - ${medida}cm`;
                } else {
                    if (!medida) {
                        alert('Por favor selecciona la medida de la barra');
                        return;
                    }
                    sistemaNombreCompleto = `${sistemaNombre} - ${medida}cm`;
                }
            }

            const tejido = TEJIDOS.find(t => t.nombre === tejidoNombre);
            if (!tejido) {
                alert('Tejido no encontrado');
                return;
            }

            const anchoParaTejido = dosPiezas ? ancho / 2 : ancho;

            let tejidoMetros = 0;

            if (tipo === 'estor_paquetto' || tipo === 'estor_plegable')
                tejidoMetros = (anchoParaTejido + 40) / 100;
            else if (tipo === 'cortina_onda_perfecta')
                tejidoMetros = (anchoParaTejido * 2.4) / 100;
            else if (tipo === 'cortina_ollados')
                tejidoMetros = (anchoParaTejido * 2.2) / 100;
            else if (tipo === 'cortina_plana')
                tejidoMetros = (anchoParaTejido * 1.4) / 100;
            else if (tipo === 'cortina_fruncida')
                tejidoMetros = (anchoParaTejido * 2.5) / 100;
            else if (tipo === 'cortina_triple_pliegue')
                tejidoMetros = (anchoParaTejido * 2.7) / 100;
            else if (tipo === 'cortina_palas')
                tejidoMetros = (anchoParaTejido * 2.6) / 100;
            else if (tipo === 'cortina_plana_doble')
                tejidoMetros = (anchoParaTejido * 2) / 100;
            else if (tipo === 'cortina_plegones')
                tejidoMetros = (anchoParaTejido * 2.6) / 100;

            tejidoMetros = Math.round(tejidoMetros * 100) / 100;

            const precioTejido = tejidoMetros * tejido.precio;
            const confeccion = CONFECCION[tipo];

            let precioConfeccion = 0;

            if (anchoParaTejido <= 100) precioConfeccion = confeccion[100];
            else if (anchoParaTejido <= 150) precioConfeccion = confeccion[150];
            else if (anchoParaTejido <= 200) precioConfeccion = confeccion[200];
            else if (anchoParaTejido <= 250) precioConfeccion = confeccion[250];
            else if (anchoParaTejido <= 300) precioConfeccion = confeccion[300];
            else precioConfeccion = confeccion[350] || confeccion[300];

            const precioSistema = calcularPrecioSistema(ancho, sistemaNombre);
            const precioTejidoFinal = dosPiezas ? precioTejido * 2 : precioTejido;
            const precioConfeccionFinal = dosPiezas ? precioConfeccion * 2 : precioConfeccion;

            let precioOllados = 0;

            if (tipo === 'cortina_ollados') {
                const tejidoCm = ancho * 2.2; 
                let numOllados = Math.floor(tejidoCm / 15);

                if (numOllados % 2 === 0) numOllados += 2;
                else numOllados += 3;

                precioOllados = numOllados * 5.5;
            }

            const precioInstalacion = document.getElementById('incluir-instalacion').checked ? 50 : 0;

            const precioTotal = 
                precioTejidoFinal + 
                precioConfeccionFinal + 
                precioSistema + 
                precioOllados + 
                precioInstalacion;

            const item = {
                id: editandoItemId || Date.now(),
                tipo,
                descripcion: `${TIPOS_NOMBRE[tipo]} - ${tejidoNombre} (${tejidoColor})${dosPiezas ? ' - 2 piezas' : ''}`,
                tejido_color: tejidoColor,
                ancho, 
                alto,
                tejido_nombre: tejidoNombre,
                sistema_nombre: sistemaNombreCompleto,
                precio_total: precioTotal,
                dos_piezas: dosPiezas,
                incluye_instalacion: precioInstalacion > 0
            };

            if (editandoItemId) {
                const index = itemsActuales.findIndex(i => i.id === editandoItemId);
                if (index !== -1) {
                    itemsActuales[index] = item;
                }
                editandoItemId = null;
                document.getElementById('btn-texto').textContent = '‚ûï Agregar al Presupuesto';
            } else {
                itemsActuales.push(item);
            }

            actualizarItems();
            actualizarResumen();
            limpiarCamposItem();
        }

        function limpiarCamposItem() {
            document.getElementById('tipo-cortina').value = '';
            document.getElementById('ancho').value = '';
            document.getElementById('alto').value = '';
            document.getElementById('tejido').value = '';
            document.getElementById('tejido-search').value = '';
            
            const colorHidden = document.getElementById('tejido-color-hidden');
            if (colorHidden) {
                colorHidden.value = '';
            }
            
            document.getElementById('color-container').style.display = 'none';
            document.getElementById('sistema').value = '';
            document.getElementById('dos-piezas').checked = false;
            document.getElementById('incluir-instalacion').checked = false;
            
            const opcionesBarras = document.getElementById('opciones-barras');
            if (opcionesBarras) {
                opcionesBarras.style.display = 'none';
            }
        }

        function eliminarItem(id) {
            if (confirm('¬øEliminar este item del presupuesto?')) {
                itemsActuales = itemsActuales.filter(item => item.id !== id);
                if (editandoItemId === id) {
                    editandoItemId = null;
                    document.getElementById('btn-texto').textContent = '‚ûï Agregar al Presupuesto';
                }
                actualizarItems();
                actualizarResumen();
            }
        }
        
        function editarItem(id) {
            const item = itemsActuales.find(i => i.id === id);
            if (!item) return;
            
            document.getElementById('tipo-cortina').value = item.tipo;
            filtrarSistemasPorTipo();
            
            document.getElementById('ancho').value = item.ancho;
            document.getElementById('alto').value = item.alto;
            document.getElementById('tejido').value = item.tejido_nombre;
            document.getElementById('tejido-search').value = item.tejido_nombre;
            document.getElementById('dos-piezas').checked = item.dos_piezas || false;
            document.getElementById('incluir-instalacion').checked = item.incluye_instalacion || false;
            
            if (item.tejido_color) {
                seleccionarTejido(item.tejido_nombre);
                setTimeout(() => {
                    const colorHidden = document.getElementById('tejido-color-hidden');
                    if (colorHidden) {
                        colorHidden.value = item.tejido_color;
                        document.querySelectorAll('.color-option').forEach(opt => {
                            const optText = opt.textContent.trim();
                            if (optText === item.tejido_color) {
                                opt.classList.add('selected');
                            }
                        });
                    }
                }, 150);
            }
            
            const esForja = Object.keys(SISTEMAS).some(s => SISTEMAS[s] === 'forja' && item.sistema_nombre.includes(s));
            
            if (esForja) {
                let sistemaForja = '';
                Object.keys(SISTEMAS).forEach(s => {
                    if (SISTEMAS[s] === 'forja' && item.sistema_nombre.includes(s)) {
                        sistemaForja = s;
                    }
                });
                
                document.getElementById('sistema').value = sistemaForja;
                mostrarOpcionesBarras();
                
                const match = item.sistema_nombre.match(/(\d+)mm - (\d+)cm/);
                if (match) {
                    document.getElementById('diametro-barra').value = match[1];
                    document.getElementById('medida-barra').value = match[2];
                } else {
                    const matchMedida = item.sistema_nombre.match(/- (\d+)cm/);
                    if (matchMedida) {
                        document.getElementById('medida-barra').value = matchMedida[1];
                    }
                }
            } else {
                const sistemaValue = item.sistema_nombre === 'Sin sistema' ? '' : item.sistema_nombre;
                document.getElementById('sistema').value = sistemaValue;
            }
            
            document.getElementById('btn-texto').textContent = '‚úèÔ∏è Actualizar Item';
            editandoItemId = id;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function actualizarItems() {
            const lista = document.getElementById('items-list');
            const card = document.getElementById('items-card');
            
            if (itemsActuales.length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            lista.innerHTML = '';
            
            itemsActuales.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'item slide-in';
                div.innerHTML = `
                    <div class="item-info">
                        <h4>#${index + 1} - ${item.descripcion}</h4>
                        <p>üìê ${item.ancho}cm √ó ${item.alto}cm | üîß ${item.sistema_nombre}</p>
                    </div>
                    <div class="item-actions" style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                        <div class="item-price">${item.precio_total.toFixed(2)}‚Ç¨</div>
                        <button class="btn btn-warning" onclick="editarItem(${item.id})" style="padding: 0.5rem 1rem; flex-shrink: 0;">
                            ‚úèÔ∏è <span class="hide-mobile">Editar</span>
                        </button>
                        <button class="btn btn-danger" onclick="eliminarItem(${item.id})" style="padding: 0.5rem 1rem; flex-shrink: 0;">
                            üóëÔ∏è <span class="hide-mobile">Eliminar</span>
                        </button>
                    </div>
                `;
                lista.appendChild(div);
            });
        }

        function actualizarResumen() {
            const totalItems = itemsActuales.length;
            const subtotal = itemsActuales.reduce((sum, item) => sum + item.precio_total, 0);
            const iva = subtotal * 0.21;
            const total = subtotal + iva;

            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('subtotal').textContent = subtotal.toFixed(2) + '‚Ç¨';
            document.getElementById('iva').textContent = iva.toFixed(2) + '‚Ç¨';
            document.getElementById('total').textContent = total.toFixed(2) + '‚Ç¨';
        }

        function guardarPresupuesto() {
            const nombre = document.getElementById('cliente-nombre').value;
            if (!nombre) {
                alert('Por favor ingresa el nombre del cliente');
                return;
            }
            if (itemsActuales.length === 0) {
                alert('Agrega al menos un item al presupuesto');
                return;
            }

            const subtotal = itemsActuales.reduce((sum, item) => sum + item.precio_total, 0);
            const total = subtotal * 1.21;

            let presupuestos = JSON.parse(localStorage.getItem('presupuestos') || '[]');
            
            if (editandoPresupuestoId) {
                const index = presupuestos.findIndex(p => p.id === editandoPresupuestoId);
                if (index !== -1) {
                    presupuestos[index] = {
                        ...presupuestos[index],
                        cliente_nombre: nombre,
                        cliente_telefono: document.getElementById('cliente-telefono').value,
                        cliente_email: document.getElementById('cliente-email').value,
                        cliente_direccion: document.getElementById('cliente-direccion').value,
                        items: itemsActuales,
                        total_sin_iva: subtotal,
                        total_con_iva: total,
                        notas: document.getElementById('notas').value
                    };
                    localStorage.setItem('presupuestos', JSON.stringify(presupuestos));
                    alert('‚úÖ Presupuesto actualizado correctamente');
                    editandoPresupuestoId = null;
                }
            } else {
                const presupuesto = {
                    id: Date.now().toString(),
                    numero: String(presupuestos.length + 1).padStart(4, '0'),
                    cliente_nombre: nombre,
                    cliente_telefono: document.getElementById('cliente-telefono').value,
                    cliente_email: document.getElementById('cliente-email').value,
                    cliente_direccion: document.getElementById('cliente-direccion').value,
                    fecha: new Date().toISOString().split('T')[0],
                    items: itemsActuales,
                    total_sin_iva: subtotal,
                    total_con_iva: total,
                    estado: 'borrador',
                    notas: document.getElementById('notas').value
                };
                presupuestos.push(presupuesto);
                localStorage.setItem('presupuestos', JSON.stringify(presupuestos));
                alert('‚úÖ Presupuesto guardado correctamente');
            }
            
            localStorage.removeItem('borrador_presupuesto');
            mostrarVista('dashboard');
        }

        function guardarBorrador() {
            const borrador = {
                cliente_nombre: document.getElementById('cliente-nombre').value,
                cliente_telefono: document.getElementById('cliente-telefono').value,
                cliente_email: document.getElementById('cliente-email').value,
                cliente_direccion: document.getElementById('cliente-direccion').value,
                notas: document.getElementById('notas').value,
                items: itemsActuales,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('borrador_presupuesto', JSON.stringify(borrador));
            alert('üìù Borrador guardado correctamente. Puedes continuar m√°s tarde.');
        }

        function cargarBorrador() {
            const borrador = localStorage.getItem('borrador_presupuesto');
            if (!borrador) return false;
            
            const datos = JSON.parse(borrador);
            
            if (confirm('¬øDeseas cargar el borrador guardado?')) {
                document.getElementById('cliente-nombre').value = datos.cliente_nombre || '';
                document.getElementById('cliente-telefono').value = datos.cliente_telefono || '';
                document.getElementById('cliente-email').value = datos.cliente_email || '';
                document.getElementById('cliente-direccion').value = datos.cliente_direccion || '';
                document.getElementById('notas').value = datos.notas || '';
                itemsActuales = datos.items || [];
                actualizarItems();
                actualizarResumen();
                localStorage.removeItem('borrador_presupuesto');
                return true;
            }
            return false;
        }

        function cargarDashboard() {
            const presupuestos = JSON.parse(localStorage.getItem('presupuestos') || '[]');
            document.getElementById('total-presupuestos').textContent = presupuestos.length;
            
            const ahora = new Date();
            const esteMes = presupuestos.filter(p => {
                const fecha = new Date(p.fecha);
                return fecha.getMonth() === ahora.getMonth() && fecha.getFullYear() === ahora.getFullYear();
            }).length;
            document.getElementById('total-mes').textContent = esteMes;

            const tbody = document.querySelector('#tabla-presupuestos tbody');
            tbody.innerHTML = '';
            
            if (presupuestos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2.5rem; color: #64748b;">No hay presupuestos. ¬°Crea el primero!</td></tr>';
                return;
            }

            const presupuestosOrdenados = [...presupuestos].reverse();
            
            presupuestosOrdenados.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td onclick="verDetalle('${p.id}')" style="font-weight: 600;">${p.numero}</td>
                    <td onclick="verDetalle('${p.id}')">${p.cliente_nombre}</td>
                    <td onclick="verDetalle('${p.id}')" class="hide-mobile">${new Date(p.fecha).toLocaleDateString('es-ES')}</td>
                    <td onclick="verDetalle('${p.id}')" class="hide-mobile">${p.items.length}</td>
                    <td onclick="verDetalle('${p.id}')" style="text-align: right; font-weight: bold; color: #60a5fa;">${p.total_con_iva.toFixed(2)}‚Ç¨</td>
                    <td style="text-align: center;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-warning" onclick="event.stopPropagation(); editarPresupuesto('${p.id}', event);" style="padding: 0.5rem 0.75rem; font-size: 0.8rem;">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); eliminarPresupuesto('${p.id}', event);" style="padding: 0.5rem 0.75rem; font-size: 0.8rem;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function eliminarPresupuesto(id, event) {
            event.stopPropagation();
            if (confirm('¬øEst√°s seguro de eliminar este presupuesto?')) {
                let presupuestos = JSON.parse(localStorage.getItem('presupuestos') || '[]');
                presupuestos = presupuestos.filter(p => p.id !== id);
                localStorage.setItem('presupuestos', JSON.stringify(presupuestos));
                
                if (document.getElementById('dashboard-view').classList.contains('hidden')) {
                    cargarGestion();
                } else {
                    cargarDashboard();
                }
            }
        }

        function verDetalle(id) {
            const presupuestos = JSON.parse(localStorage.getItem('presupuestos') || '[]');
            const p = presupuestos.find(pr => pr.id === id);
            if (!p) return;

            window.location.hash = `#detalle?id=${id}`;

            document.getElementById('detalle-content').innerHTML = `
                <div class="aviso-orientativo">
                    <strong>‚ö†Ô∏è PRESUPUESTO ORIENTATIVO</strong>
                    <p>Los precios est√°n sujetos a confirmaci√≥n tras toma de medidas definitiva.</p>
                </div>
                <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem; padding: 1.5rem; border-bottom: 3px solid rgba(99, 102, 241, 0.3); background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%); border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h2 style="color: #60a5fa; font-size: 1.5rem; margin-bottom: 0.5rem;">CANOTEX</h2>
                            <p style="color: #cbd5e1; font-size: 0.75rem;">Tel: 973235776 | info@canotex.es</p>
                        </div>
                        <div style="text-align: right;">
                            <h2 style="color: #60a5fa; font-size: 1.5rem; margin-bottom: 0.5rem;">PRESUPUESTO</h2>
                            <p style="font-size: 0.85rem; color: #cbd5e1;">N¬∫: ${p.numero}</p>
                            <p style="font-size: 0.85rem; color: #cbd5e1;">Fecha: ${new Date(p.fecha).toLocaleDateString('es-ES')}</p>
                        </div>
                    </div>
                </div>
                ${p.cliente_nombre ? `
                    <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.12) 0%, rgba(139, 92, 246, 0.12) 100%); padding: 1.25rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid rgba(99, 102, 241, 0.25);">
                        <h3 style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">CLIENTE</h3>
                        <p style="font-weight: 700; font-size: 1.1rem; color: #e2e8f0; margin-bottom: 0.5rem;">${p.cliente_nombre}</p>
                        ${p.cliente_telefono ? `<p style="font-size: 0.875rem; color: #cbd5e1;">üìû ${p.cliente_telefono}</p>` : ''}
                        ${p.cliente_email ? `<p style="font-size: 0.875rem; color: #cbd5e1;">üìß ${p.cliente_email}</p>` : ''}
                        ${p.cliente_direccion ? `<p style="font-size: 0.875rem; color: #cbd5e1;">üìç ${p.cliente_direccion}</p>` : ''}
                    </div>
                ` : ''}
                <h3 style="margin-bottom: 1rem; font-size: 1.25rem; color: #e2e8f0;">üìã Detalle del Presupuesto</h3>
                <div class="tabla-wrapper">
                    <table class="tabla">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Descripci√≥n</th>
                                <th class="hide-mobile">Medidas</th>
                                <th class="hide-mobile">Sistema</th>
                                <th style="text-align: right;">Precio</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${p.items.map((item, i) => `
                                <tr>
                                    <td style="font-weight: 600;">${i + 1}</td>
                                    <td>
                                        <div style="font-weight: 500;">${item.descripcion}</div>
                                        <div class="show-mobile" style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem;">
                                            ${item.ancho} √ó ${item.alto} cm
                                        </div>
                                    </td>
                                    <td class="hide-mobile" style="color: #cbd5e1;">${item.ancho} √ó ${item.alto} cm</td>
                                    <td class="hide-mobile" style="color: #cbd5e1;">${item.sistema_nombre || 'Sin sistema'}</td>
                                    <td style="text-align: right; font-weight: 700; color: #60a5fa; font-size: 1.05rem;">${item.precio_total.toFixed(2)}‚Ç¨</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="display: flex; justify-content: flex-end; margin-top: 2rem;">
                    <div style="width: 100%; max-width: 20rem;">
                        <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                            <span style="color: #cbd5e1;">Subtotal:</span>
                            <strong style="color: #e2e8f0; font-size: 1.05rem;">${p.total_sin_iva.toFixed(2)}‚Ç¨</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                            <span style="color: #cbd5e1;">IVA (21%):</span>
                            <strong style="color: #e2e8f0; font-size: 1.05rem;">${(p.total_sin_iva * 0.21).toFixed(2)}‚Ç¨</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 1.25rem; background: linear-gradient(135deg, rgba(96, 165, 250, 0.2) 0%, rgba(167, 139, 250, 0.2) 100%); margin-top: 0.75rem; border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.3);">
                            <span style="font-weight: bold; font-size: 1.1rem; color: #e2e8f0;">TOTAL:</span>
                            <span style="font-size: 1.75rem; font-weight: bold; background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">${p.total_con_iva.toFixed(2)}‚Ç¨</span>
                        </div>
                    </div>
                </div>
                ${p.notas ? `
                    <div style="margin-top: 2rem; padding: 1.25rem; background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.15) 100%); border-radius: 12px; border: 1px solid rgba(251, 191, 36, 0.3);">
                        <h4 style="font-weight: 600; margin-bottom: 0.75rem; color: #fbbf24;">üìù Notas:</h4>
                        <p style="color: #e2e8f0; line-height: 1.6;">${p.notas}</p>
                    </div>
                ` : ''}
                <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(255, 255, 255, 0.1); text-align: center; font-size: 0.75rem; color: #94a3b8; line-height: 1.6;">
                    <p>‚úÖ Presupuesto v√°lido por 30 d√≠as</p>
                    <p style="margin-top: 0.5rem;">Canotex Textil S.L. - C/ Pened√©s, 87 - 25005 Lleida</p>
                </div>
            `;
            mostrarVista('detalle');
        }

        function limpiarFormulario() {
            document.getElementById('cliente-nombre').value = '';
            document.getElementById('cliente-telefono').value = '';
            document.getElementById('cliente-email').value = '';
            document.getElementById('cliente-direccion').value = '';
            document.getElementById('notas').value = '';
            document.getElementById('incluir-instalacion').checked = false;
            document.getElementById('btn-texto').textContent = '‚ûï Agregar al Presupuesto';
            itemsActuales = [];
            editandoItemId = null;
            editandoPresupuestoId = null;
            actualizarItems();
            actualizarResumen();
        }
      
        function editarPresupuesto(id, event) {
            event.stopPropagation();
            
            const presupuestos = JSON.parse(localStorage.getItem('presupuestos') || '[]');
            const p = presupuestos.find(pr => pr.id === id);
            if (!p) return;
            
            editandoPresupuestoId = id;
            
            mostrarVista('nuevo');
            
            document.getElementById('cliente-nombre').value = p.cliente_nombre || '';
            document.getElementById('cliente-telefono').value = p.cliente_telefono || '';
            document.getElementById('cliente-email').value = p.cliente_email || '';
            document.getElementById('cliente-direccion').value = p.cliente_direccion || '';
            document.getElementById('notas').value = p.notas || '';
            
            itemsActuales = (p.items || []).map(item => ({
                ...item,
                id: item.id || Date.now() + Math.random()
            }));
            
            actualizarItems();
            actualizarResumen();
            
            const btnGuardar = document.querySelector('button[onclick="guardarPresupuesto()"]');
            if (btnGuardar) {
                btnGuardar.innerHTML = 'üíæ Actualizar Presupuesto';
                btnGuardar.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                btnGuardar.style.color = 'white';
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      
        function toggleMenu() {
            document.getElementById('menu-lateral').classList.toggle('active');
            document.getElementById('menu-overlay').classList.toggle('active');
        }

        function enviarEmailAyuda() {
            window.location.href = 'mailto:info@canotex.es?subject=Solicitud de Ayuda - Sistema Presupuestos&body=Hola, necesito ayuda con el sistema de presupuestos.%0D%0A%0D%0AMi consulta es:%0D%0A';
        }

        function cargarGestion() {
            filtrarPresupuestos();
        }

        function filtrarPresupuestos() {
            const presupuestos = JSON.parse(localStorage.getItem('presupuestos') || '[]');
            const nombre = document.getElementById('filtro-nombre').value.toLowerCase();
            const numero = document.getElementById('filtro-numero').value.toLowerCase();
            const fechaDesde = document.getElementById('filtro-fecha-desde').value;
            const fechaHasta = document.getElementById('filtro-fecha-hasta').value;

            let filtrados = presupuestos.filter(p => {
                const matchNombre = !nombre || p.cliente_nombre.toLowerCase().includes(nombre);
                const matchNumero = !numero || p.numero.includes(numero);
                
                let matchFecha = true;
                if (fechaDesde && p.fecha < fechaDesde) matchFecha = false;
                if (fechaHasta && p.fecha > fechaHasta) matchFecha = false;
                
                return matchNombre && matchNumero && matchFecha;
            });

            const tbody = document.getElementById('tabla-gestion-body');
            tbody.innerHTML = '';
            document.getElementById('total-resultados').textContent = filtrados.length;

            if (filtrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2.5rem; color: #64748b;">No se encontraron presupuestos con estos filtros</td></tr>';
                return;
            }

            const filtradosOrdenados = [...filtrados].reverse();
            
            filtradosOrdenados.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight: 600;">${p.numero}</td>
                    <td>${p.cliente_nombre}</td>
                    <td class="hide-mobile">${new Date(p.fecha).toLocaleDateString('es-ES')}</td>
                    <td class="hide-mobile">${p.items.length}</td>
                    <td style="text-align: right; font-weight: bold; color: #60a5fa;">${p.total_con_iva.toFixed(2)}‚Ç¨</td>
                    <td style="text-align: center;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-warning" onclick="event.stopPropagation(); editarPresupuesto('${p.id}', event);" style="padding: 0.5rem 0.75rem; font-size: 0.8rem;">‚úèÔ∏è</button>
                            <button class="btn btn-primary" onclick="event.stopPropagation(); verDetalle('${p.id}');" style="padding: 0.5rem 0.75rem; font-size: 0.8rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">üëÅÔ∏è</button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); eliminarPresupuesto('${p.id}', event);" style="padding: 0.5rem 0.75rem; font-size: 0.8rem;">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function mostrarPresupuestosDelMes() {
            const ahora = new Date();
            const primerDia = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
            const ultimoDia = new Date(ahora.getFullYear(), ahora.getMonth() + 1, 0);

            document.getElementById('filtro-nombre').value = '';
            document.getElementById('filtro-numero').value = '';
            document.getElementById('filtro-fecha-desde').value = primerDia.toISOString().split('T')[0];
            document.getElementById('filtro-fecha-hasta').value = ultimoDia.toISOString().split('T')[0];
            
            mostrarVista('gestion');
        }

        function mostrarGraficaMensual() {
            mostrarVista('grafica');
            cargarGraficaMensual();
        }

        function cargarGraficaMensual() {
            const presupuestos = JSON.parse(localStorage.getItem('presupuestos') || '[]');
            const nombresMeses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const anioActual = new Date().getFullYear();
            
            const conteoPorMes = new Array(12).fill(0);

            presupuestos.forEach(p => {
                const fecha = new Date(p.fecha);
                if (fecha.getFullYear() === anioActual) {
                    conteoPorMes[fecha.getMonth()]++;
                }
            });

            const maxValor = Math.max(...conteoPorMes, 1);
            const contenedor = document.getElementById('grafica-barras');
            contenedor.innerHTML = '';

            conteoPorMes.forEach((valor, i) => {
                const altura = (valor / maxValor) * 100;
                const barra = document.createElement('div');
                barra.className = 'barra';
                
                if (valor === 0) barra.classList.add('low');
                else if (valor <= 2) barra.classList.add('low');
                else if (valor <= 5) barra.classList.add('medium');
                else if (valor <= 10) barra.classList.add('high');
                else barra.classList.add('very-high');
                
                barra.style.height = `${Math.max(altura, 5)}%`;
                barra.style.cursor = 'pointer';
                
                barra.innerHTML = `
                    <div class="barra-valor">${valor}</div>
                    <div class="barra-label">${nombresMeses[i]}</div>
                `;

                barra.onclick = () => filtrarPorMes(i, anioActual);
                
                contenedor.appendChild(barra);
            });
        }

        function filtrarPorMes(mesIndex, anio) {
            const primerDia = new Date(anio, mesIndex, 1);
            const ultimoDia = new Date(anio, mesIndex + 1, 0);
            
            document.getElementById('filtro-nombre').value = '';
            document.getElementById('filtro-numero').value = '';
            document.getElementById('filtro-fecha-desde').value = primerDia.toISOString().split('T')[0];
            document.getElementById('filtro-fecha-hasta').value = ultimoDia.toISOString().split('T')[0];
            
            mostrarVista('gestion');
        }

        async function generarYEnviarPDF() {
            const hashParams = window.location.hash.split('?')[1];
            const urlParams = new URLSearchParams(hashParams || '');
            const presupuestoId = urlParams.get('id');
            
            if (!presupuestoId) {
                alert('Error: No se pudo identificar el presupuesto');
                return;
            }

            const presupuestos = JSON.parse(localStorage.getItem('presupuestos') || '[]');
            const p = presupuestos.find(pr => pr.id === presupuestoId);
            
            if (!p) {
                alert('Error: Presupuesto no encontrado');
                return;
            }

            const btnEnviar = event.target;
            const textoOriginal = btnEnviar.innerHTML;
            btnEnviar.disabled = true;
            btnEnviar.innerHTML = '‚è≥ Generando PDF...';

            try {
                const contenido = document.getElementById('detalle-content');
                
                const copia = contenido.cloneNode(true);
                copia.style.cssText = `
                    background: white !important;
                    color: #000 !important;
                    padding: 40px;
                    position: absolute;
                    left: -9999px;
                    top: 0;
                    width: 800px;
                `;
                document.body.appendChild(copia);

                copia.querySelectorAll('*').forEach(el => {
                    el.style.webkitTextFillColor = '#000';
                    el.style.color = '#000';
                    if (el.style.background && el.style.background.includes('gradient')) {
                        el.style.background = 'transparent';
                    }
                });

                const canvas = await html2canvas(copia, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true
                });

                document.body.removeChild(copia);

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const imgData = canvas.toDataURL('image/png');
                
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                const nombreArchivo = `Presupuesto_${p.numero}_${p.cliente_nombre.replace(/\s+/g, '_')}.pdf`;
                
                pdf.save(nombreArchivo);

                btnEnviar.innerHTML = '‚úÖ PDF Descargado';
                
                setTimeout(() => {
                    const asunto = `Presupuesto ${p.numero} - ${p.cliente_nombre}`;
                    const cuerpo = `Estimado/a,

Presupuesto solicitado:

‚Ä¢ Presupuesto N¬∫: ${p.numero}
‚Ä¢ Cliente: ${p.cliente_nombre}
‚Ä¢ Fecha: ${new Date(p.fecha).toLocaleDateString('es-ES')}
‚Ä¢ Total: ${p.total_con_iva.toFixed(2)}‚Ç¨ (IVA incluido)

Por favor, adjunta manualmente el archivo PDF que se acaba de descargar: "${nombreArchivo}";

                    
                    window.location.href = `mailto:info@canotex.es?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
                    
                    setTimeout(() => {
                        btnEnviar.innerHTML = textoOriginal;
                        btnEnviar.disabled = false;
                    }, 2000);
                    
                }, 1000);

            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('‚ùå Error al generar el PDF: ' + error.message + '\n\nInt√©ntalo de nuevo o usa la opci√≥n Imprimir.');
                btnEnviar.innerHTML = textoOriginal;
                btnEnviar.disabled = false;
            }
        }
    </script>
</body>
</html>
